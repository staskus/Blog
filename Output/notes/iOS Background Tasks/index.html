<!DOCTYPE html><html lang="en"><head><title>Povilas Staškus - Senior iOS Engineer @Automattic</title><meta name="twitter:title" content="Povilas Staškus - Senior iOS Engineer @Automattic"/><meta name="og:title" content="Povilas Staškus - Senior iOS Engineer @Automattic"/><meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css"/><link rel="stylesheet" href="/Pure/styles.css"/><link rel="stylesheet" href="/all.css"/></head><body><div id="layout" class="pure-g"><div><div class="pure-menu pure-menu-horizontal pure-u-1-1 top-header"><a class="pure-menu-heading" href="/">staskus.io</a><ul class="pure-menu-list"><li class="pure-menu-item"><a class="pure-menu-link" href="/about">About</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/archive">Archive</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/afterWork">After work</a></li></ul></div></div><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><div id="layout" class="pure-g"><div class="author__avatar"><img src="https://avatars0.githubusercontent.com/u/4062343?s=460&v=4"/></div><div class="pure-u-md-1-1 pure-u-3-4"><h1 class="brand-title">Povilas Staškus</h1><h3 class="brand-tagline">Senior iOS Engineer @Automattic</h3></div></div><div id="layout" class="pure-g"><div class="pure-u-md-1-1"><a href="https://en.wikipedia.org/wiki/Vilnius"><i class="fas fa-map-marker-alt l-box social-icon"></i><a class="social-media" href="https://en.wikipedia.org/wiki/Vilnius">Vilnius, Lithuania</a></a></div><div class="pure-u-md-1-1"><a href="mailto:povilas@staskus.io"><i class="fas fa-envelope-open-text l-box social-icon"></i><a class="social-media" href="mailto:povilas@staskus.io">Email</a></a></div><div class="pure-u-md-1-1"><a href="https://www.linkedin.com/in/povilas-staškus-6b10528b"><i class="fab fa-linkedin l-box social-icon"></i><a class="social-media" href="https://www.linkedin.com/in/povilas-staškus-6b10528b">LinkedIn</a></a></div><div class="pure-u-md-1-1"><a href="https://github.com/staskus"><i class="fab fa-github-square l-box social-icon"></i><a class="social-media" href="https://github.com/staskus">GitHub</a></a></div><div class="pure-u-md-1-1"><a href="https://twitter.com/PovilasStaskus"><i class="fab fa-twitter-square l-box social-icon"></i><a class="social-media" href="https://twitter.com/PovilasStaskus">Twitter</a></a></div></div></div></div><div class="content pure-u-1 pure-u-md-3-5 pure-u-xl-6-10"><h2 class="post-title"><a href="/notes/iOS Background Tasks">Background Tasks</a></h2><p class="post-meta">Last modified: 2022 June 3</p><div class="post-description"><div><p>https://developer.apple.com/documentation/backgroundtasks/choosing<em>background</em>strategies<em>for</em>your_app</p><h2>Factors affecting runtime</h2><ol><li>Critically low batter</li><li>Low Power Mode</li><li>App usage (AI learns about app usage)</li><li>App switcher (if user explicitly kills specific app)</li><li>Background App Refresh switch (there's notification to know when switch is changed)</li><li>System budgets (every app has a system defined budget)</li><li>Rate limiting</li></ol><h2>Background App Refresh tasks</h2><h2>Background pushes</h2><p>Background pushes silently wakes up the app without displaying any alert or playing the sound.</p><p>Once the system delivers the remote notification with application<code>(_:didReceiveRemoteNotification:fetchCompletionHandler:)</code>, the app has up to 30 seconds to complete its work. One your app performs the work, call the passed completion handler as soon as possible to conserve power.</p><h2>URLSession background transfers</h2><pre><code>

<span class="keyword">private lazy var</span> urlSession: <span class="type">URLSession</span> = {
    <span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="call">background</span>(withIdentifier: <span class="string">"MySession"</span>)
    config.<span class="property">isDiscretionary</span> = <span class="keyword">true</span> <span class="comment">// System waits for optimal conditions to perform the transfer</span>
    config.<span class="property">sessionSendsLaunchEvents</span> = <span class="keyword">true</span> <span class="comment">// System wakes up the app when the ask completes and the app is in the background</span>
    <span class="keyword">return</span> <span class="type">URLSession</span>(configuration: config, delegate: <span class="keyword">self</span>, delegateQueue: <span class="keyword">nil</span>)
}()

<span class="comment">// System calls this method when the download finishes
// Store the completion handler to call later</span>
<span class="keyword">func</span> application(<span class="keyword">_</span> application: <span class="type">UIApplication</span>,
                 handleEventsForBackgroundURLSession identifier: <span class="type">String</span>,
                 completionHandler: <span class="keyword">@escaping</span> () -&gt; <span class="type">Void</span>) {
        backgroundCompletionHandler = completionHandler
}

<span class="keyword">func</span> urlSessionDidFinishEvents(forBackgroundURLSession session: <span class="type">URLSession</span>) {
    <span class="type">DispatchQueue</span>.<span class="property">main</span>.<span class="call">async</span> {
        <span class="keyword">guard let</span> appDelegate = <span class="type">UIApplication</span>.<span class="property">shared</span>.<span class="property">delegate</span> <span class="keyword">as</span>? <span class="type">AppDelegate</span>,
            <span class="keyword">let</span> backgroundCompletionHandler =
            appDelegate.<span class="property">backgroundCompletionHandler</span> <span class="keyword">else</span> {
                <span class="keyword">return</span>
        }
        <span class="call">backgroundCompletionHandler</span>()
    }
}
</code></pre><h2>Notify the user about a background task</h2><p>If your app needs to perform a task in the background and show a notification to the user, use a Notification Service Extension. For example, an email app might need to notify a user after downloading a new email. Subclass <code>UNNotificationServiceExtension</code> and bundle the system extension with your app. Upon receiving a push notification, your service extension wakes up and obtains background runtime through didReceive(_:withContentHandler:). When your extension completes its work, it must call the content handler with the content you want to deliver to the user. Your extension has a limited amount of time to modify the content and execute the contentHandler block.</p><h2>Background processing tasks</h2><p>To preserve battery life and performance, you can schedule backgrounds tasks for periods of low activity, such as overnight when the device charges. Use this approach when your app manages heavy workloads, such as training machine learning models or performing database maintenance. Schedule these types of background tasks using <code>BGProcessingTask</code>, and the system decides the best time to launch your background task.</p></div></div></div><div class="footer pure-u-1"><div class="pure-u-1">© 2023 Povilas Staškus</div><div class="pure-u-1">Generated using <a href="https://github.com/johnsundell/publish">Publish</a></div><div class="pure-u-1"><a href="/feed.rss">RSS feed</a></div></div></div></body></html>