<!DOCTYPE html><html lang="en"><head><title>Povilas Staškus - Senior iOS Engineer @Automattic</title><meta name="twitter:title" content="Povilas Staškus - Senior iOS Engineer @Automattic"/><meta name="og:title" content="Povilas Staškus - Senior iOS Engineer @Automattic"/><meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css"/><link rel="stylesheet" href="/Pure/styles.css"/><link rel="stylesheet" href="/all.css"/></head><body><div id="layout" class="pure-g"><div><div class="pure-menu pure-menu-horizontal pure-u-1-1 top-header"><a class="pure-menu-heading" href="/">staskus.io</a><ul class="pure-menu-list"><li class="pure-menu-item"><a class="pure-menu-link" href="/about">About</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/archive">Archive</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="/afterWork">After work</a></li></ul></div></div><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><div id="layout" class="pure-g"><div class="author__avatar"><img src="https://avatars0.githubusercontent.com/u/4062343?s=460&v=4"/></div><div class="pure-u-md-1-1 pure-u-3-4"><h1 class="brand-title">Povilas Staškus</h1><h3 class="brand-tagline">Senior iOS Engineer @Automattic</h3></div></div><div id="layout" class="pure-g"><div class="pure-u-md-1-1"><a href="https://en.wikipedia.org/wiki/Vilnius"><i class="fas fa-map-marker-alt l-box social-icon"></i><a class="social-media" href="https://en.wikipedia.org/wiki/Vilnius">Vilnius, Lithuania</a></a></div><div class="pure-u-md-1-1"><a href="mailto:povilas@staskus.io"><i class="fas fa-envelope-open-text l-box social-icon"></i><a class="social-media" href="mailto:povilas@staskus.io">Email</a></a></div><div class="pure-u-md-1-1"><a href="https://www.linkedin.com/in/povilas-staškus-6b10528b"><i class="fab fa-linkedin l-box social-icon"></i><a class="social-media" href="https://www.linkedin.com/in/povilas-staškus-6b10528b">LinkedIn</a></a></div><div class="pure-u-md-1-1"><a href="https://github.com/staskus"><i class="fab fa-github-square l-box social-icon"></i><a class="social-media" href="https://github.com/staskus">GitHub</a></a></div><div class="pure-u-md-1-1"><a href="https://twitter.com/PovilasStaskus"><i class="fab fa-twitter-square l-box social-icon"></i><a class="social-media" href="https://twitter.com/PovilasStaskus">Twitter</a></a></div></div></div></div><div class="content pure-u-1 pure-u-md-3-5 pure-u-xl-6-10"><h2 class="post-title"><a href="/notes/iOS AV">Audio &amp; Video</a></h2><p class="post-meta">Last modified: 2022 December 31</p><div class="post-description"><div><p>AVFoundation uses the AVAsset class to progressively download from a remote host, and stream-based media that a host serves using <em>HTTP Live Streaming</em>.</p><p>AVFoundation is a wrapper around CoreAudio, CoreMedia, CoreVideo and CoreAnimation.</p><p>Main features: 1. Inspect 2. Playback 3. Export 4. Capture 5. Compose</p><h2>Loading</h2><p><code>AVAsset</code> models the static aspects of a media resource. Creating an <code>AVAsset</code> does not load the resource, media is not loaded until prompted.</p><p>Asset inspection is also an asynchronous process. We only get what we ask for.</p><p>We load values by providing keys to a loading method.</p><pre><code><span class="keyword">let</span> url: <span class="type">URL</span> = <span class="comment">// A URL to a local or remote media resource.</span>
<span class="keyword">let</span> asset = <span class="type">AVAsset</span>(url: url)
<span class="comment">// Load the value of the asset's duration property asynchronously.</span>
asset.<span class="call">loadValuesAsynchronously</span>(forKeys: [<span class="string">"duration"</span>]) {
    <span class="keyword">var</span> error: <span class="type">NSError</span>?
    <span class="keyword">if</span> asset.<span class="call">statusOfValue</span>(forKey: <span class="string">"duration"</span>, error: &amp;error) == .<span class="dotAccess">loaded</span> {
        <span class="comment">// Access the property value synchronously.</span>
        <span class="call">presentDuration</span>(asset.<span class="property">duration</span>) <span class="comment">// If we call asset.duration before loading, it would block I/O!</span>
    }
}
</code></pre><p>Swift 5.5 way. Old way will be deprrecated.</p><pre><code><span class="keyword">func</span> inspectAsset() async <span class="keyword">throws</span> {
    <span class="keyword">let</span> asset = <span class="type">AVAsset</span>(url: movieURL)
    <span class="keyword">let</span> duration = <span class="keyword">try</span> await asset.<span class="call">load</span>(.<span class="dotAccess">duration</span>)
    <span class="call">myFunction</span>(thatUses: duration)
}

<span class="keyword">func</span> inspectAsset() async <span class="keyword">throws</span> {
    <span class="keyword">let</span> asset = <span class="type">AVAsset</span>(url: movieURL)
    <span class="keyword">let</span> (duration, tracks) = <span class="keyword">try</span> await asset.<span class="call">load</span>(.<span class="dotAccess">duration</span>, .<span class="dotAccess">tracks</span>)
    <span class="call">myFunction</span>(thatUses: duration, and: tracks)
}
</code></pre><img src="/images/notes/1bccd220960e2615c1c6b0933efea56e88b83393de2c8d325a749f8d37b9e4f6.png" alt="Apple.com"/><p>We can export and save files using similar<code>exportAsynchronouslyWithCompletionHandler</code>.</p><p>AVFoundation distinguishes between static and dynamic aspects of media: 1. Static: AVAsset, AVAssetTrack... 2. Dynamic: AVplayerItem, AVPlayerItemTrack...</p><h2>Media Playback with AVKit</h2><p><code>AVKit</code> is built on top of <code>AVFoundation</code>. Allows to reuse intuitive Apple UI, with <code>AVPlayerViewController</code> and <code>AVRoutePickerView</code>.</p><pre><code><span class="keyword">import</span> AVKit

<span class="keyword">let</span> player = <span class="type">AVPlayer</span>(url: <span class="string">"https://stream.com/video.m3u3"</span>)

<span class="keyword">let</span> playerViewController = <span class="type">AVPlayerViewController</span>()
playerViewController.<span class="property">player</span> = player

<span class="call">present</span>(...)
</code></pre><h2>Time</h2><p>Time is presented by <code>CMTime</code> or <code>CMTimeRange</code> (containing start and end times).</p><h2>HTTP Live Streaming</h2><img src="/images/notes/92fd3d4ecd5caee3c6cc2980d0918499ff0b5588294b07575264314b0f8e47ca.png" alt="picture 3"/><p>https://developer.apple.com/streaming/</p><p>HLS consists of 3 parts: 1. Server (resposible for encoding, encapsulating in a format suitable for delivery and distribution) 2. Distribution (web-server or web-caching system that delivers media files or index files over HTTP)/ 3. Client (begings by fetching the index file, using a URL that identifies the stream)</p><p>AVAssetVariant: - Bitrate (32.91Mbps) - Audio attributes (ec-3, channels) - Video attributes (dvh1, resolution, fps)</p><p>HLS downloads: - Introduced in 2016</p><p>Streaming tools: - https://developer.apple.com/documentation/http<em>live</em>streaming/using<em>apple</em>s<em>http</em>live<em>streaming</em>hls_tools</p></div></div></div><div class="footer pure-u-1"><div class="pure-u-1">© 2023 Povilas Staškus</div><div class="pure-u-1">Generated using <a href="https://github.com/johnsundell/publish">Publish</a></div><div class="pure-u-1"><a href="/feed.rss">RSS feed</a></div></div></div></body></html>